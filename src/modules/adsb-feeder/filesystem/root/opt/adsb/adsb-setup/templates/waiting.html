<!DOCTYPE html>
{% if env_value_by_tag is defined %}
{% if env_value_by_tag("css_theme") == 'light' %}
<html lang="en" data-mdb-theme="light">
{% elif env_value_by_tag("css_theme") == 'dark' %}
<html lang="en" data-mdb-theme="dark">
{% else %}
<html lang="en" data-mdb-theme="auto">
{% endif %}
{% endif %}

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <!-- Google Fonts Roboto. Copyright 2011 Google Inc. All Rights Reserved. See {{ url_for('static', filename='fonts/LICENSE.txt') }} -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/fonts.css') }}" />
  <!-- MDB -->
  <link rel="stylesheet" id="css-theme" href="{{ url_for('static', filename='css/mdb.min.css') }}" />
  {% if env_value_by_tag is defined %}
  {% if not ((env_value_by_tag("css_theme") == 'light') or (env_value_by_tag("css_theme") == 'dark')) %}
  <script>
    ; (function () {
      const htmlElement = document.querySelector("html")
      if (htmlElement.getAttribute("data-mdb-theme") === 'auto') {
        function updateTheme() {
          document.querySelector("html").setAttribute("data-mdb-theme",
            window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light")
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateTheme)
        updateTheme()
      }
    })()
  </script>
  {% endif %}
  {% endif %}
  {% if env_value_by_tag('aggregator_choice') == 'nonadsb' %}
  <link rel="shortcut icon" href="/static/favicon-sdr.ico" />
  {% else %}
  <link rel="shortcut icon" href="/static/favicon.ico" />
  {% endif %}
  <!-- Spinner -->
  <link rel="stylesheet" href="/static/css/style.css" />
<title>
    {{ title }}
  </title>
</head>

<body>
  <div id="loader" style="display: none">
    <div class="plane-animation">
      <div class="clouds">
        <div class="cloud cloud1">
          <svg viewBox="0 0 21 19" xmlns="http://www.w3.org/2000/svg">
            <path d="m3 13.649c0 2.9551 2.4177 5.3507 5.4 5.3507h8.1c2.4853 0 4.5-2.0161 4.5-4.5031 0-1.8466-1.1107-3.552-2.7-4.2469-0.1683-2.9275-2.616-5.25-5.6107-5.25-2.3379 0-4.3424 1.4864-5.1893 3.5-2.7 0.4375-4.5 2.7001-4.5 5.1493z" stroke="none"/>
          </svg>
        </div>
        <div class="cloud cloud2">
          <svg viewBox="0 0 21 19" xmlns="http://www.w3.org/2000/svg">
            <path d="m3 13.649c0 2.9551 2.4177 5.3507 5.4 5.3507h8.1c2.4853 0 4.5-2.0161 4.5-4.5031 0-1.8466-1.1107-3.552-2.7-4.2469-0.1683-2.9275-2.616-5.25-5.6107-5.25-2.3379 0-4.3424 1.4864-5.1893 3.5-2.7 0.4375-4.5 2.7001-4.5 5.1493z" stroke="none"/>
          </svg>
        </div>
        <div class="cloud cloud3">
          <svg viewBox="0 0 21 19" xmlns="http://www.w3.org/2000/svg">
            <path d="m3 13.649c0 2.9551 2.4177 5.3507 5.4 5.3507h8.1c2.4853 0 4.5-2.0161 4.5-4.5031 0-1.8466-1.1107-3.552-2.7-4.2469-0.1683-2.9275-2.616-5.25-5.6107-5.25-2.3379 0-4.3424 1.4864-5.1893 3.5-2.7 0.4375-4.5 2.7001-4.5 5.1493z" stroke="none"/>
          </svg>
        </div>
        <div class="cloud cloud4">
          <svg viewBox="0 0 21 19" xmlns="http://www.w3.org/2000/svg">
            <path d="m3 13.649c0 2.9551 2.4177 5.3507 5.4 5.3507h8.1c2.4853 0 4.5-2.0161 4.5-4.5031 0-1.8466-1.1107-3.552-2.7-4.2469-0.1683-2.9275-2.616-5.25-5.6107-5.25-2.3379 0-4.3424 1.4864-5.1893 3.5-2.7 0.4375-4.5 2.7001-4.5 5.1493z" stroke="none"/>
          </svg>
        </div>
        <div class="cloud cloud5">
          <svg viewBox="0 0 21 19" xmlns="http://www.w3.org/2000/svg">
            <path d="m3 13.649c0 2.9551 2.4177 5.3507 5.4 5.3507h8.1c2.4853 0 4.5-2.0161 4.5-4.5031 0-1.8466-1.1107-3.552-2.7-4.2469-0.1683-2.9275-2.616-5.25-5.6107-5.25-2.3379 0-4.3424 1.4864-5.1893 3.5-2.7 0.4375-4.5 2.7001-4.5 5.1493z" stroke="none"/>
          </svg>
        </div>
      </div>
      <div class="plane">
        <svg viewBox="0 0 32 29" xmlns="http://www.w3.org/2000/svg">
          <path d="M30.8,14.2C30.1,13.4,29,13,28,13H8.5L4.8,8.4C4.6,8.1,4.3,8,4,8H1C0.7,8,0.4,8.1,0.2,8.4C0,8.6,0,9,0,9.3l3,11  C3.2,20.7,3.6,21,4,21h6.4l-3.3,6.6c-0.2,0.3-0.1,0.7,0,1C7.3,28.8,7.7,29,8,29h4c0.3,0,0.6-0.1,0.7-0.3l6.9-7.7H28  c1.1,0,2.1-0.4,2.8-1.2c0.8-0.8,1.2-1.8,1.2-2.8S31.6,14.9,30.8,14.2z"/>
          <path d="M10.4,11h8.5l-5.1-5.7C13.6,5.1,13.3,5,13,5H9C8.7,5,8.3,5.2,8.1,5.5C8,5.8,8,6.1,8.1,6.4L10.4,11z"/>
        </svg>
      </div>
    </div>
    <div class="loading-text">System updating...</div>
  </div>
  <div id="overlay" style="display: none">
    <div id="overlaytext">
      please wait
      <br />
      this could take several minutes
    </div>
  </div>
  <div class="bgimage">
    {% if env_value_by_tag('aggregator_choice') == 'nonadsb' %}
    <img src="/static/images/sdrim-background-transparent-4k.png" alt="">
    {% else %}
    <img src="/static/images/adsbim-background-transparent-4k.png" alt="">
    {% endif %}
  </div>
  <div class="container pt-5 mt-3">
    <h1>{{ title }}</h1>
    <h3 class="my-3">Please be patient</h3>
    <div class="row overflow-auto" style="height: 75vh" id="logcontainer">
      <pre class="col-6-sm col-12 small" id="log"></pre>
    </div>
  </div>

  <script src="/static/js/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8="
          crossorigin="anonymous"></script>

  <script>
    // make sure we can propagate the target number if provided
    const target = new URLSearchParams(window.location.search).get('m');
    let extraArgs = "";
    if (target) {
      extraArgs = "?m=" + target;
    }

    function stream() {
      var streamlog = new EventSource("/stream-log");
      console.log("created EventSource")
      streamErrorHandled = false;
      streamlog.onerror = function (e) {
        streamlog.close();
        console.log("streamlog error");
        checkSoon(0);
      }
      streamlog.onmessage = function (e) {
        $('#log').append(e.data + "\n");
        $('#logcontainer').scrollTop($('#logcontainer')[0].scrollHeight);
      };
    }
    // wait_restart python function waits 0.9s, so make this a bit longer than that
    // if the timeout is too short due to RTT, it will be increased automatically

    let httpTimeout = 1000;
    let httpTimeoutMax = 10000;
    const checkDelay = 500;
    let checkTimer = null;

    function checkSoon(delay) {
      if (delay == undefined) {
        delay = checkDelay;
      }
      clearTimeout(checkTimer);
      checkTimer = setTimeout(checkStatus, delay);
    }

    function checkStatus() {
      var request = new XMLHttpRequest();
      request.open('GET', '/restart');

      request.timeout = httpTimeout;
      request.ontimeout = function () {
        httpTimeout = Math.min(httpTimeoutMax, httpTimeout * 1.5);
        console.log(`timeout: wait and try /restart again`);
        checkSoon(0);
        return;
      };

      request.onerror = function () {
        console.log("request returned an error - let's hope it's just restarting and try again");
        checkSoon(checkDelay);
        return;
      };

      request.onload = function () {
        if (request.readyState === 4 && request.status === 200) {
          if (request.responseText === 'done') {
            console.log('adsb-setup webinterface indicates ready, redirect user to /');
            window.location = '/' + extraArgs;
            return;
          } else if (request.responseText === 'busy') {
            console.log('webinterface running, continue reading the stream log, redirect user to /waiting');
            window.location = '/waiting' + extraArgs;
            return;
          } else if (request.responseText === 'stream-log') {
            console.log('waiting-app running, continue reading the stream log, redirect user to /waiting');
            window.location = '/waiting' + extraArgs;
            return;
          } else {
            console.log("waiting.html: request to GET /restart returned unexpected responseText: ", request.responseText);
            checkSoon(checkDelay);
            return;
          }
        } else {
          console.log(`waiting.html: request returned with readyState ${request.readyState}, status ${request.status} and text ${request.responseText}; keep waiting`);
          checkSoon(checkDelay);
          return;
        }
      };

      request.send();
    };

    console.log("starting stream");
    stream();

    let tinyScreen = window.matchMedia("(max-width: 480px)");
    tinyScreen.addEventListener("change", ({ matches }) => adjustFont(matches));
    function adjustFont(matches) {
      if (matches) {
        $("#log").css("font-size", "30%");
      } else {
        $("#log").css("font-size", "50%");
      }
    }
    adjustFont(tinyScreen.matches);

  </script>
</body>

</html>
